<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sign-In Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-box { border: 2px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .pending { border-color: #ffc107; background: #fff3cd; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç Google Sign-In Diagnostic Tool</h1>
    <p>This page tests each component of the Google Sign-In system.</p>

    <!-- Test 1: WordPress Endpoint -->
    <div id="test1" class="test-box pending">
        <h3>Test 1: WordPress Endpoint Check</h3>
        <p>Testing: <code>https://db.store1920.com/wp-json/custom/v1/google-login</code></p>
        <button onclick="testEndpoint()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <!-- Test 2: Firebase Config -->
    <div id="test2" class="test-box pending">
        <h3>Test 2: Firebase Configuration</h3>
        <p>Checking if Firebase is properly initialized...</p>
        <button onclick="testFirebase()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <!-- Test 3: Pop-up Test -->
    <div id="test3" class="test-box pending">
        <h3>Test 3: Pop-up Blocker Test</h3>
        <p>Testing if browser allows pop-ups...</p>
        <button onclick="testPopup()">Run Test</button>
        <div id="test3-result"></div>
    </div>

    <!-- Test 4: Full Flow -->
    <div id="test4" class="test-box pending">
        <h3>Test 4: Full Google Sign-In Flow</h3>
        <p>Attempt actual Google sign-in (requires all above tests to pass)</p>
        <button onclick="testFullFlow()">Run Full Test</button>
        <div id="test4-result"></div>
    </div>

    <!-- Console Log -->
    <div class="test-box">
        <h3>üìù Console Log</h3>
        <div id="console-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC1_taRzacQqdbjL4qdjsv_HxRS4lEThKA",
            authDomain: "store1920-7d673.firebaseapp.com",
            projectId: "store1920-7d673",
            storageBucket: "store1920-7d673.firebasestorage.app",
            messagingSenderId: "999210993204",
            appId: "1:999210993204:web:2829662f9e52a489c32c61"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.auth = auth;
        window.provider = provider;
        window.signInWithPopup = signInWithPopup;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.log = log;

        // Test 1: WordPress Endpoint
        window.testEndpoint = async function() {
            log('üîµ Testing WordPress endpoint...');
            const resultDiv = document.getElementById('test1-result');
            
            try {
                const response = await fetch('https://db.store1920.com/wp-json/custom/v1/google-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        name: 'Test User',
                        firebase_uid: 'test123',
                        photo_url: ''
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('test1').className = 'test-box success';
                    resultDiv.innerHTML = `<strong>‚úÖ SUCCESS</strong><br>Endpoint is working!<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    log('‚úÖ WordPress endpoint is working', 'success');
                } else {
                    document.getElementById('test1').className = 'test-box error';
                    resultDiv.innerHTML = `<strong>‚ùå ERROR</strong><br>Status: ${response.status}<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    log(`‚ùå Endpoint returned error: ${response.status}`, 'error');
                }
            } catch (err) {
                document.getElementById('test1').className = 'test-box error';
                resultDiv.innerHTML = `<strong>‚ùå FAILED</strong><br>${err.message}<br><br><strong>Solution:</strong> Upload wordpress-google-login-endpoint.php to WordPress`;
                log(`‚ùå Endpoint test failed: ${err.message}`, 'error');
            }
        };

        // Test 2: Firebase
        window.testFirebase = function() {
            log('üîµ Testing Firebase configuration...');
            const resultDiv = document.getElementById('test2-result');
            
            try {
                if (auth && provider) {
                    document.getElementById('test2').className = 'test-box success';
                    resultDiv.innerHTML = `<strong>‚úÖ SUCCESS</strong><br>Firebase is initialized<br>Auth Domain: ${firebaseConfig.authDomain}`;
                    log('‚úÖ Firebase is properly configured', 'success');
                } else {
                    throw new Error('Firebase not initialized');
                }
            } catch (err) {
                document.getElementById('test2').className = 'test-box error';
                resultDiv.innerHTML = `<strong>‚ùå FAILED</strong><br>${err.message}`;
                log(`‚ùå Firebase test failed: ${err.message}`, 'error');
            }
        };

        // Test 3: Pop-up
        window.testPopup = function() {
            log('üîµ Testing pop-up blocker...');
            const resultDiv = document.getElementById('test3-result');
            
            try {
                const popup = window.open('', '', 'width=1,height=1');
                
                if (popup) {
                    popup.close();
                    document.getElementById('test3').className = 'test-box success';
                    resultDiv.innerHTML = `<strong>‚úÖ SUCCESS</strong><br>Pop-ups are allowed`;
                    log('‚úÖ Pop-ups are enabled', 'success');
                } else {
                    throw new Error('Pop-up blocked');
                }
            } catch (err) {
                document.getElementById('test3').className = 'test-box error';
                resultDiv.innerHTML = `<strong>‚ùå BLOCKED</strong><br>Please enable pop-ups for this site<br><br><strong>How to fix:</strong><br>1. Look for blocked icon in address bar<br>2. Click and allow pop-ups<br>3. Refresh page`;
                log('‚ùå Pop-ups are blocked', 'error');
            }
        };

        // Test 4: Full Flow
        window.testFullFlow = async function() {
            log('üîµ Starting full Google Sign-In test...');
            const resultDiv = document.getElementById('test4-result');
            
            try {
                log('Opening Google Sign-In popup...');
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                log(`‚úÖ Firebase authentication successful: ${user.email}`, 'success');
                
                // Send to WordPress
                log('Sending data to WordPress...');
                const wpResponse = await fetch('https://db.store1920.com/wp-json/custom/v1/google-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        name: user.displayName || user.email,
                        firebase_uid: user.uid,
                        photo_url: user.photoURL || ''
                    })
                });
                
                const wpData = await wpResponse.json();
                
                if (wpResponse.ok) {
                    document.getElementById('test4').className = 'test-box success';
                    resultDiv.innerHTML = `<strong>‚úÖ SUCCESS!</strong><br>User: ${user.email}<br>WordPress User ID: ${wpData.user_id}<br><pre>${JSON.stringify(wpData, null, 2)}</pre>`;
                    log('‚úÖ Full flow completed successfully!', 'success');
                } else {
                    throw new Error(`WordPress error: ${JSON.stringify(wpData)}`);
                }
                
            } catch (err) {
                document.getElementById('test4').className = 'test-box error';
                resultDiv.innerHTML = `<strong>‚ùå FAILED</strong><br>${err.message}<br><br>Check console log above for details`;
                log(`‚ùå Full flow failed: ${err.message}`, 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('console-log').innerHTML = '';
        };

        // Auto-run basic tests on load
        log('üöÄ Diagnostic tool loaded');
        log('Run each test to identify issues');
    </script>
</body>
</html>
